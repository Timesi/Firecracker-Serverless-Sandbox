FROM ubuntu:20.04
ENV DEBIAN_FRONTEND=noninteractive

# å®‰è£…åŸºç¡€å·¥å…·ï¼šPython3ï¼Œä»¥åŠå¿…è¦çš„ç³»ç»Ÿå·¥å…·
RUN apt-get update && apt-get install -y \
    python3 python3-pip \
    util-linux \
    && rm -rf /var/lib/apt/lists/*

# è®¾ç½®ä¸»æœºå
RUN echo "my-microvm" > /etc/hostname

# è®¾ç½® root å¯†ç 
RUN echo "root:root" | chpasswd

# å…è®¸ä¸²å£ç™»å½•
RUN echo "ttyS0" >> /etc/securetty

# åˆ›å»ºå¿…è¦æŒ‚è½½ç‚¹ç›®å½•
RUN mkdir -p /proc /sys /dev /tmp /sbin /etc/init.d

# æ³¨å…¥ä»£ç æ‰§è¡Œæ–‡ä»¶
COPY guest/supervisor.py /usr/bin/supervisor.py
COPY guest/kernel.py /usr/bin/kernel.py

# å…ˆæŠŠå†…å®¹å†™åˆ°ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶é‡Œ
# ----------------------------------------------------------------------
# æ‰‹åŠ¨ç¼–å†™æç®€ Init è„šæœ¬ (/sbin/init)
#
# ä¸ºäº†æé€Ÿå¯åŠ¨ï¼Œæˆ‘ä»¬ä¸ä½¿ç”¨ Systemd æˆ– SysVinitï¼Œè€Œæ˜¯ç›´æ¥é€šè¿‡ Shell è„šæœ¬åˆå§‹åŒ–ç³»ç»Ÿã€‚
# è¿™ä½¿å¾—å¯åŠ¨è¿‡ç¨‹ä»…éœ€å‡ æ¯«ç§’ã€‚
# ----------------------------------------------------------------------
RUN cat > /sbin/init.tmp <<'EOF'
#!/bin/sh
# æŒ‚è½½å¿…è¦çš„è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ
mount -t proc proc /proc
mount -t sysfs sys /sys
mount -t devtmpfs none /dev

# å…³é”®å®‰å…¨é…ç½®ï¼š
# å› ä¸º Rootfs æ˜¯ä»¥åªè¯» (Read-Only) æ¨¡å¼æŒ‚è½½çš„ï¼Œæˆ‘ä»¬å¿…é¡»æŠŠéœ€è¦å†™å…¥çš„ç›®å½•æŒ‚è½½ä¸º tmpfs (å†…å­˜ç›˜)ã€‚
# è¿™æ ·ä¸ä»…ä¿æŠ¤äº†é•œåƒï¼Œè¿˜ä¿è¯äº†æ¯æ¬¡é‡å¯åäº§ç”Ÿçš„åƒåœ¾æ–‡ä»¶éƒ½ä¼šè‡ªåŠ¨æ¶ˆå¤± (Ephemeral Storage)ã€‚
# æŒ‚è½½ /tmp ä¸ºçº¯å†…å­˜ç›˜
mount -t tmpfs tmpfs /tmp
# åˆ›å»ºä¸€ä¸ªä¸“ç”¨çš„çº¯å†…å­˜å·¥ä½œåŒºï¼Œåˆ†é… 256MB
mkdir -p /workspace
mount -t tmpfs -o size=256m tmpfs /workspace

hostname my-microvm

[ -c /dev/null ] || mknod -m 666 /dev/null c 1 3
[ -c /dev/random ] || mknod -m 666 /dev/random c 1 8
[ -c /dev/urandom ] || mknod -m 666 /dev/urandom c 1 9
[ -c /dev/zero ] || mknod -m 666 /dev/zero c 1 5
[ -c /dev/console ] || mknod -m 600 /dev/console c 5 1
[ -c /dev/tty ] || mknod -m 666 /dev/tty c 5 0
[ -c /dev/ttyS0 ] || mknod -m 660 /dev/ttyS0 c 4 64

# å› ä¸ºæ ¹ç›®å½•åªè¯»ï¼Œæ—¥å¿—å¿…é¡»å†™åˆ° /tmp ä¸‹
echo "å¯åŠ¨ Supervisor å®ˆæŠ¤è¿›ç¨‹..."
nohup python3 /usr/bin/supervisor.py > /tmp/supervisor.log 2>&1 &

echo ""
echo "========================================"
echo "ğŸ‰ Serverless Sandbox å¯åŠ¨æˆåŠŸ! (Read-Only Mode)"
echo "========================================"
echo ""

exec /bin/bash --login
EOF

# åˆ é™¤æ‰€æœ‰ \r å­—ç¬¦ï¼Œå†™å…¥æœ€ç»ˆçš„ /sbin/initï¼Œå¹¶èµ‹äºˆæ‰§è¡Œæƒé™
RUN tr -d '\r' < /sbin/init.tmp > /sbin/init && \
    rm /sbin/init.tmp && \
    chmod +x /sbin/init